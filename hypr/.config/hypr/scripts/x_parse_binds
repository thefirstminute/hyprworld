#!/usr/bin/env bash

KEYBIND_DIR="$HOME/.config/hypr/keys"

collect_binds() {
    shopt -s nullglob

    for file in "$KEYBIND_DIR"/*.conf; do
        meta=""

        while IFS= read -r line; do
            # meta tags
            if [[ $line =~ ^#meta:\ (.*)$ ]]; then
                meta="${BASH_REMATCH[1]}"
                continue
            fi

            # any bind variant
            if [[ $line =~ ^[[:space:]]*bind[a-z]*[[:space:]]*=[[:space:]]*(.*)$ ]]; then
                rest="${BASH_REMATCH[1]}"

                # split by comma safely
                IFS=',' read -ra parts <<< "$rest"

                # cleanup
                for i in "${!parts[@]}"; do
                    parts[$i]=$(echo "${parts[$i]}" | xargs)
                done

                mod="${parts[0]}"
                key="${parts[1]}"

                # description only exists in bindd (3rd field)
                if [[ $line =~ ^[[:space:]]*bindd ]]; then
                    desc=$(echo "${parts[2]}" | sed 's/^"//; s/"$//')
                    cmd="${parts[@]:3}"
                else
                    desc=""
                    cmd="${parts[@]:2}"
                fi

                # strip exec/dispatch
                cmd=$(echo "$cmd" | sed 's/^exec,//; s/^exec//; s/^dispatch,//; s/^dispatch//')

                printf "%s\t%s\t%s\t%s\t%s\n" \
                    "$file" "$mod+$key" "$desc" "$cmd" "$meta"

                meta=""
            fi
        done < "$file"
    done
}

collect_binds

