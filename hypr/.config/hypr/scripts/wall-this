#!/usr/bin/env bash
set -euo pipefail

# make sure hyprpaper is running
if ! pgrep -x "hyprpaper" > /dev/null; then
    nohup hyprpaper >/dev/null 2>&1 & 
    sleep 2
fi

WALLPAPER_DIR="$HOME/.wallpapers"

# Pick category via rofi
category=$(ls "$WALLPAPER_DIR" | rofi -dmenu -p "Pick theme")
if [ -z "$category" ]; then
    echo "No category selected, exiting."
    exit 0
fi
echo "Category: $category"

# Get focused monitor + resolution
monitor=$(hyprctl monitors -j | jq -r '.[] | select(.focused==true).name')
width=$(hyprctl monitors -j | jq -r '.[] | select(.focused==true).width')
height=$(hyprctl monitors -j | jq -r '.[] | select(.focused==true).height')

echo "Monitor: $monitor"
echo "Resolution: ${width}x${height}"

# Orientation
orient="h"
[ "$height" -gt "$width" ] && orient="v"
echo "Orientation: $orient"

# Pick random wallpaper
folder="$WALLPAPER_DIR/$category/$orient"
if [ ! -d "$folder" ]; then
    echo "ERROR: Folder $folder does not exist."
    exit 1
fi

wallpaper=$(find "$folder" -type f | shuf -n 1)
if [ -z "$wallpaper" ]; then
    echo "ERROR: No wallpapers found in $folder."
    exit 1
fi
echo "Selected wallpaper: $wallpaper"

# Set wallpaper
echo "Preloading wallpaper..."
if ! hyprctl hyprpaper preload "$wallpaper"; then
    echo "ERROR: preload failed."
    exit 1
fi

echo "Applying wallpaper to $monitor..."
if ! hyprctl hyprpaper wallpaper "$monitor,$wallpaper"; then
    echo "ERROR: wallpaper command failed."
    exit 1
fi

# pywal set colors from wall paper:
if command -v wal >/dev/null 2>&1; then
    wal -al -i "$wallpaper"

    # Reload waybar
    if command -v waybar >/dev/null 2>&1; then
        pkill waybar
        waybar &
    fi


fi

echo "Done."
