#!/bin/bash

INTERVAL=${1:-1320} # Default 22 mins (1320s)
WP_ROOT=${2:-"$HOME/.wallpapers/abstract"}
MON=$(hyprctl monitors -j | jq -r '.[] | select(.focused==true).name')
PID_FILE="/tmp/hypr_wp_$MON.pid"

# Stop function
if [[ "$1" == "stop" ]]; then
    [[ -f "$PID_FILE" ]] && kill $(cat "$PID_FILE") && rm "$PID_FILE"
    exit 0
fi

# Kill existing instance for this monitor
[[ -f "$PID_FILE" ]] && kill $(cat "$PID_FILE") 2>/dev/null

echo $$ > "$PID_FILE"

while true; do
    ROT=$(hyprctl monitors -j | jq -r ".[] | select(.name==\"$MON\").transform")
    SUBDIR="h"
    [[ "$ROT" != "0" ]] && SUBDIR="v"
    
    WP_PATH=$(find "$WP_ROOT/$SUBDIR" -type f 2>/dev/null | shuf -n 1)

    if [ -n "$WP_PATH" ]; then
        hyprctl hyprpaper preload "$WP_PATH"
        hyprctl hyprpaper wallpaper "$MON,$WP_PATH"
        sleep 1
        hyprctl hyprpaper unload all
    fi
    sleep "$INTERVAL"
done
